#!/bin/bash

set -euo pipefail
source $(dirname $0)/var.sh

LIB_PATH=modules/ffmpeg
FLAGS=(
  --target-os=none        # use none to prevent any os specific configurations
  --arch=x86_32           # use x86_32 to achieve minimal architectural optimization
  --enable-cross-compile
  --enable-gpl            # required by x264
  --enable-version3
  --enable-libmp3lame
  --enable-libopus
  --enable-librubberband
  --enable-gpl
  --disable-postproc
  --disable-doc
  --disable-debug
  --disable-avdevice
  --disable-swscale
  --disable-programs
  --enable-rdft
  --disable-network
  --disable-muxers
  --disable-demuxers
  --disable-zlib
  --disable-bzlib
  --disable-iconv
  --disable-bsfs
  --disable-filters
  --disable-parsers
  --disable-indevs
  --disable-outdevs
  --disable-encoders
  --disable-decoders
  --disable-hwaccels
  --disable-nvenc
  --disable-xvmc
  --disable-videotoolbox
  --disable-audiotoolbox
  --disable-filters
  --enable-filter=aformat
  --enable-filter=anull
  --enable-filter=aresample
  --enable-filter=amerge
  --enable-filter=atrim
  --enable-filter=format
  --enable-filter=null
  --enable-filter=setpts
  --enable-filter=trim
  --enable-filter=anullsrc
  --enable-filter=acompressor
  --enable-filter=acontrast
  --enable-filter=acopy
  --enable-filter=acrossfade
  --enable-filter=acrossover
  --enable-filter=acrusher
  --enable-filter=acue
  --enable-filter=adeclick
  --enable-filter=adeclip
  --enable-filter=adecorrelate
  --enable-filter=adelay
  --enable-filter=adenorm
  --enable-filter=aderivative
  --enable-filter=aintegral
  --enable-filter=adynamicequalizer
  --enable-filter=adynamicsmooth
  --enable-filter=aecho
  --enable-filter=aemphasis
  --enable-filter=aeval
  --enable-filter=aexciter
  --enable-filter=afade
  --enable-filter=afftdn
  --enable-filter=afftfilt
  --enable-filter=afir
  --enable-filter=aformat
  --enable-filter=afreqshift
  --enable-filter=afwtdn
  --enable-filter=agate
  --enable-filter=aiir
  --enable-filter=alimiter
  --enable-filter=allpass
  --enable-filter=aloop
  --enable-filter=amerge
  --enable-filter=amix
  --enable-filter=amultiply
  --enable-filter=anequalizer
  --enable-filter=anlmdn
  --enable-filter=anlmf
  --enable-filter=anlms
  --enable-filter=anull
  --enable-filter=apad
  --enable-filter=aphaser
  --enable-filter=aphaseshift
  --enable-filter=apsyclip
  --enable-filter=apulsator
  --enable-filter=aresample
  --enable-filter=areverse
  --enable-filter=arnndn
  --enable-filter=asdr
  --enable-filter=asetnsamples
  --enable-filter=asetrate
  --enable-filter=ashowinfo
  --enable-filter=asoftclip
  --enable-filter=aspectralstats
  --enable-filter=asr
  --enable-filter=astats
  --enable-filter=asubboost
  --enable-filter=asubcut
  --enable-filter=asupercut
  --enable-filter=asuperpass
  --enable-filter=asuperstop
  --enable-filter=atempo
  --enable-filter=atilt
  --enable-filter=atrim
  --enable-filter=axcorrelate
  --enable-filter=bandpass
  --enable-filter=bandreject
  --enable-filter=bass
  --enable-filter=lowshelf
  --enable-filter=biquad
  --enable-filter=bs2b
  --enable-filter=channelmap
  --enable-filter=channelsplit
  --enable-filter=chorus
  --enable-filter=compand
  --enable-filter=compensationdelay
  --enable-filter=crossfeed
  --enable-filter=crystalizer
  --enable-filter=dcshift
  --enable-filter=deesser
  --enable-filter=dialoguenhance
  --enable-filter=drmeter
  --enable-filter=dynaudnorm
  --enable-filter=earwax
  --enable-filter=equalizer
  --enable-filter=extrastereo
  --enable-filter=firequalizer
  --enable-filter=flanger
  --enable-filter=haas
  --enable-filter=hdcd
  --enable-filter=headphone
  --enable-filter=highpass
  --enable-filter=join
  --enable-filter=ladspa
  --enable-filter=loudnorm
  --enable-filter=lowpass
  --enable-filter=lv2
  --enable-filter=mcompand
  --enable-filter=pan
  --enable-filter=Mixing
  --enable-filter=Remapping
  --enable-filter=replaygain
  --enable-filter=resample
  --enable-filter=rubberband
  --enable-filter=sidechaincompress
  --enable-filter=sidechaingate
  --enable-filter=silencedetect
  --enable-filter=silenceremove
  --enable-filter=sofalizer
  --enable-filter=speechnorm
  --enable-filter=stereotools
  --enable-filter=stereowiden
  --enable-filter=superequalizer
  --enable-filter=surround
  --enable-filter=treble
  --enable-filter=highshelf
  --enable-filter=tremolo
  --enable-filter=vibrato
  --enable-filter=volume
  --enable-filter=volumedetect
  --disable-protocols
  --enable-protocol=file
  --enable-protocol=pipe
  --enable-demuxer=image2
  --enable-demuxer=aac
  --enable-demuxer=ac3
  --enable-demuxer=aiff
  --enable-demuxer=ape
  --enable-demuxer=asf
  --enable-demuxer=au
  --enable-demuxer=avi
  --enable-demuxer=flac
  --enable-demuxer=flv
  --enable-demuxer=matroska
  --enable-demuxer=mov
  --enable-demuxer=m4v
  --enable-demuxer=mp3
  --enable-demuxer=mpc
  --enable-demuxer=mpc8
  --enable-demuxer=ogg
  --enable-demuxer=pcm_alaw
  --enable-demuxer=pcm_mulaw
  --enable-demuxer=pcm_f64be
  --enable-demuxer=pcm_f64le
  --enable-demuxer=pcm_f32be
  --enable-demuxer=pcm_f32le
  --enable-demuxer=pcm_s32be
  --enable-demuxer=pcm_s32le
  --enable-demuxer=pcm_s24be
  --enable-demuxer=pcm_s24le
  --enable-demuxer=pcm_s16be
  --enable-demuxer=pcm_s16le
  --enable-demuxer=pcm_s8
  --enable-demuxer=pcm_u32be
  --enable-demuxer=pcm_u32le
  --enable-demuxer=pcm_u24be
  --enable-demuxer=pcm_u24le
  --enable-demuxer=pcm_u16be
  --enable-demuxer=pcm_u16le
  --enable-demuxer=pcm_u8
  --enable-demuxer=rm
  --enable-demuxer=shorten
  --enable-demuxer=tak
  --enable-demuxer=tta
  --enable-demuxer=wav
  --enable-demuxer=wv
  --enable-demuxer=xwma
  --enable-demuxer=dsf
  --enable-decoder=aac
  --enable-decoder=aac_latm
  --enable-decoder=ac3
  --enable-decoder=alac
  --enable-decoder=als
  --enable-decoder=ape
  --enable-decoder=atrac1
  --enable-decoder=atrac3
  --enable-decoder=eac3
  --enable-decoder=flac
  --enable-decoder=gsm
  --enable-decoder=gsm_ms
  --enable-decoder=mp1
  --enable-decoder=mp1float
  --enable-decoder=mp2
  --enable-decoder=mp2float
  --enable-decoder=mp3
  --enable-decoder=mp3adu
  --enable-decoder=mp3adufloat
  --enable-decoder=mp3float
  --enable-decoder=mp3on4
  --enable-decoder=mp3on4float
  --enable-decoder=mpc7
  --enable-decoder=mpc8
  --enable-decoder=opus
  --enable-decoder=ra_144
  --enable-decoder=ra_288
  --enable-decoder=ralf
  --enable-decoder=shorten
  --enable-decoder=tak
  --enable-decoder=tta
  --enable-decoder=vorbis
  --enable-decoder=wavpack
  --enable-decoder=wmalossless
  --enable-decoder=wmapro
  --enable-decoder=wmav1
  --enable-decoder=wmav2
  --enable-decoder=wmavoice
  --enable-decoder=pcm_alaw
  --enable-decoder=pcm_bluray
  --enable-decoder=pcm_dvd
  --enable-decoder=pcm_f32be
  --enable-decoder=pcm_f32le
  --enable-decoder=pcm_f64be
  --enable-decoder=pcm_f64le
  --enable-decoder=pcm_lxf
  --enable-decoder=pcm_mulaw
  --enable-decoder=pcm_s8
  --enable-decoder=pcm_s8_planar
  --enable-decoder=pcm_s16be
  --enable-decoder=pcm_s16be_planar
  --enable-decoder=pcm_s16le
  --enable-decoder=pcm_s16le_planar
  --enable-decoder=pcm_s24be
  --enable-decoder=pcm_s24daud
  --enable-decoder=pcm_s24le
  --enable-decoder=pcm_s24le_planar
  --enable-decoder=pcm_s32be
  --enable-decoder=pcm_s32le
  --enable-decoder=pcm_s32le_planar
  --enable-decoder=pcm_u8
  --enable-decoder=pcm_u16be
  --enable-decoder=pcm_u16le
  --enable-decoder=pcm_u24be
  --enable-decoder=pcm_u24le
  --enable-decoder=pcm_u32be
  --enable-decoder=pcm_u32le
  --enable-decoder=dsd_lsbf
  --enable-decoder=dsd_msbf
  --enable-decoder=dsd_lsbf_planar
  --enable-decoder=dsd_msbf_planar
  --enable-encoder=pcm_s16le
  --enable-encoder=aac
  --enable-encoder=opus
  --enable-encoder=flac
  --enable-encoder=vorbis
  --enable-encoder=libmp3lame
  --enable-encoder=pcm_alaw
  --enable-encoder=pcm_f32be
  --enable-encoder=pcm_f32le
  --enable-encoder=pcm_f64be
  --enable-encoder=pcm_f64le
  --enable-encoder=pcm_mulaw
  --enable-encoder=pcm_s8
  --enable-encoder=pcm_s8_planar
  --enable-encoder=pcm_s16be
  --enable-encoder=pcm_s16be_planar
  --enable-encoder=pcm_s16le
  --enable-encoder=pcm_s16le_planar
  --enable-encoder=pcm_s24be
  --enable-encoder=pcm_s24daud
  --enable-encoder=pcm_s24le
  --enable-encoder=pcm_s24le_planar
  --enable-encoder=pcm_s32be
  --enable-encoder=pcm_s32le
  --enable-encoder=pcm_s32le_planar
  --enable-encoder=pcm_u8
  --enable-encoder=pcm_u16be
  --enable-encoder=pcm_u16le
  --enable-encoder=pcm_u24be
  --enable-encoder=pcm_u24le
  --enable-encoder=pcm_u32be
  --enable-encoder=pcm_u32le
  --enable-encoder=pcm_s16le
  --enable-muxer=flac
  --enable-muxer=matroska
  --enable-muxer=m4v
  --enable-muxer=mp3
  --enable-muxer=ogg
  --enable-muxer=pcm_alaw
  --enable-muxer=pcm_mulaw
  --enable-muxer=pcm_f64be
  --enable-muxer=pcm_f64le
  --enable-muxer=pcm_f32be
  --enable-muxer=pcm_f32le
  --enable-muxer=pcm_s32be
  --enable-muxer=pcm_s32le
  --enable-muxer=pcm_s24be
  --enable-muxer=pcm_s24le
  --enable-muxer=pcm_s16be
  --enable-muxer=pcm_s16le
  --enable-muxer=pcm_s8
  --enable-muxer=pcm_u32be
  --enable-muxer=pcm_u32le
  --enable-muxer=pcm_u24be
  --enable-muxer=pcm_u24le
  --enable-muxer=pcm_u16be
  --enable-muxer=pcm_u16le
  --enable-muxer=pcm_u8
  --enable-muxer=flac
  --enable-muxer=wav
  --enable-parser=aac
  --enable-parser=aac_latm
  --enable-parser=ac3
  --enable-parser=cook
  --enable-parser=dca
  --enable-parser=flac
  --enable-parser=gsm
  --enable-parser=mpegaudio
  --enable-parser=tak
  --enable-parser=vorbis
  --enable-libopus
  --enable-libmp3lame
  --enable-encoder=libopus
  --enable-decoder=libopus
  --enable-librubberband
  --enable-filter=rubberband
  --disable-x86asm
  --disable-inline-asm
  --disable-stripping
  --disable-programs      # disable programs build (incl. ffplay, ffprobe & ffmpeg)
  --disable-doc
  --disable-debug
  --disable-runtime-cpudetect
  --disable-autodetect    # disable external libraries auto detect
  --extra-cflags="$CFLAGS"
  --extra-cxxflags="$CFLAGS"
  --extra-ldflags="$LDFLAGS"
  --pkg-config-flags="--static"
  --nm="llvm-nm"
  --ar=emar
  --ranlib=emranlib
  --cc=emcc
  --cxx=em++
  --objcc=emcc
  --dep-cc=emcc
  ${EXTRA_FFMPEG_CONF_FLAGS-}
)
echo "FFMPEG_CONFIG_FLAGS=${FLAGS[@]}"
(cd $LIB_PATH && \
    PKG_CONFIG_PATH=$PWD/build/lib/pkgconfig && \
    emconfigure ./configure "${FLAGS[@]}")
